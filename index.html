<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XOCTLA - Herbolaria Tradicional Mexicana</title>

    <meta name="google-site-verification" content="EqF-lN907LJ2eiSVnIGIih9EcOzTIqytxvuHms1lU8w" />
    <meta name="google-site-verification" content="yRZhDg4ICgpwndYshhYygB3DTkjXG9hHQEht5_hx_0k" />
    <meta name="google-site-verification" content="2oNevHyT61320yoW7usvgp0Ps8b39B-W2KliNohIMCI" />

    <link rel="stylesheet" href="styles-v3.css">
</head>
<body>

    <button class="menu-toggle" aria-label="Abrir men√∫">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <nav class="main-nav">
        <ul>
            <li><a href="#presentacion">¬øQui√©nes Somos?</a></li>
            <li><a href="#productos">Productos</a></li>
            <li class="submenu-parent">
                <a href="#fichas">Fichas T√©cnicas</a>
                <ul class="submenu">
                    <li><a href="Ficha tecnica Cempas√∫chil.pdf" target="_blank">Ficha T√©cnica Cempas√∫chil</a></li>
                    <li><a href="Ficha tecnica Tomillo.pdf" target="_blank">Ficha T√©cnica Tomillo</a></li>
                    <li><a href="Ficha tecnica Arnica.pdf" target="_blank">Ficha T√©cnica √Årnica</a></li>
                </ul>
            </li>
            <li><a href="#contacto">Contacto</a></li>
        </ul>
    </nav>

    <header>
        <div class="header-content">
            <h1 class="visually-hidden">üåø XOCTLA üåº</h1>
            <img src="logo.jpeg" alt="Logo de XOCTLA" class="logo">
            <p>Rescatando La Tradici√≥n Herbolaria Mexicana</p>
        </div>

        <div class="header-controls">
            
            <div id="auth-links">
                <button id="show-login-btn" class="cta-button cta-button-small">Iniciar Sesi√≥n</button>
                <button id="show-register-btn" class="cta-button cta-button-small">Crear Cuenta</button>
            </div>
            
            <div id="user-status" style="display: none;">
                <span id="user-email"></span>
                <button id="logout-btn" class="cta-button cta-button-small">Cerrar Sesi√≥n</button>
            </div>
            
            <button id="cart-toggle-btn" class="cart-toggle-btn" aria-label="Abrir carrito">
                üõí
                <span id="cart-counter">0</span>
            </button>
        </div>
        </header>

    <div class="content">
        <main>
            <section id="presentacion">
                <h2>¬øQuienes Somos?</h2>
                <p>Somos un proyecto escolar dedicado a rescatar y presentar los beneficios de la herbolaria tradicional mexicana a trav√©s de productos sencillos y efectivos.</p>
            </section>

            <section id="productos">
                <h2>Nuestros Productos</h2>
                <div class="product-container">
                    <article class="producto cempasuchil" data-id="1" data-nombre="Aceite de Cempas√∫chil" data-precio="120">
                        <h3>üåº Aceite de Cempas√∫chil</h3>
                        <img src="https://via.placeholder.com/400x250.png?text=Cempas√∫chil" alt="Aceite de Cempas√∫chil" class="product-image">
                        <div class="product-info-wrapper">
                            <p class="product-price">$120.00 MXN</p>
                            <p>El Cempas√∫chil, la Flor de Muertos... (etc.)</p>
                            <ul>
                                <li>**Formato:** Aceite Esencial/Corporal.</li>
                                <li>**Uso Principal:** **Aromaterapia y Humectante de la piel**.</li>
                            </ul>
                        </div>
                        <button class="add-to-cart-btn">Agregar al Carrito</button>
                    </article>

                    <article class="producto tomillo" data-id="2" data-nombre="Pomada de Tomillo" data-precio="100">
                        <h3>üçÉ Pomada de Tomillo</h3>
                        <img src="https://via.placeholder.com/400x250.png?text=Tomillo" alt="Pomada de Tomillo" class="product-image">
                        <div class="product-info-wrapper">
                            <p class="product-price">$100.00 MXN</p>
                            <p>El Tomillo (**Thymus vulgaris**) ha sido utilizado ancestralmente... (etc.)</p>
                            <ul>
                                <li>**Formato:** Pomada/B√°lsamo.</li>
                                <li>**Uso Principal:** **Mejora las V√≠as respiratorias y Relajaci√≥n corporal**.</li>
                            </ul>
                        </div>
                        <button class="add-to-cart-btn">Agregar al Carrito</button>
                    </article>

                    <article class="producto arnica" data-id="3" data-nombre="Pomada de √Årnica" data-precio="110">
                        <h3>üü° Pomada de √Årnica</h3>
                        <img src="https://via.placeholder.com/400x250.png?text=√Årnica" alt="Pomada de √Årnica" class="product-image">
                        <div class="product-info-wrapper">
                            <p class="product-price">$110.00 MXN</p>
                            <p>La √Årnica es el cl√°sico remedio del botiqu√≠n... (etc.)</p>
                            <ul>
                                <li>**Formato:** Pomada/Ung√ºento.</li>
                                <li>**Uso Principal:** **Golpes y contusiones e Hinchaz√≥n**.</li>
                            </ul>
                        </div>
                        <button class="add-to-cart-btn">Agregar al Carrito</button>
                    </article>
                </div>
            </section>

            <section id="contacto">
                <h2>Contacto</h2>
                <p>¬øTienes preguntas sobre nuestros productos o el proyecto? Escr√≠benos.</p>
                <a href="mailto:xoctla.info@gmail.com" class="cta-button">Enviar un Correo</a>
            </section>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 Proyecto Escolar: Herbolaria Mexicana. Todos los derechos reservados.</p>
    </footer>

    <div id="cart-sidebar" class="cart-sidebar">
        <button id="cart-close-btn" class="cart-close-btn" aria-label="Cerrar carrito">&times;</button>
        <h2>üõí Carrito de Compras</h2>
        <div id="cart-items-container">
            <p id="cart-empty-msg">Tu carrito est√° vac√≠o.</p>
        </div>
        <div id="cart-total">
            <h3>Total: $<span id="cart-total-price">0.00</span> MXN</h3>
            <button id="checkout-btn" class="cta-button">Proceder al Pago</button>
            <p id="cart-checkout-error" class="error-message">Tu carrito est√° vac√≠o. Agrega productos antes de pagar.</p>
        </div>
    </div>

    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <button id="auth-modal-close-btn" class="modal-close-btn" aria-label="Cerrar">&times;</button>
            
            <div id="auth-step-login" class="auth-step">
                <h2>Iniciar Sesi√≥n</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Correo Electr√≥nico:</label>
                        <input type="email" id="login-email" name="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Contrase√±a:</label>
                        <input type="password" id="login-password" name="login-password" required>
                    </div>
                    <p id="login-error" class="error-message"></p>
                    <button type="submit" class="cta-button">Iniciar Sesi√≥n</button>
                    
                    <div class="auth-divider">
                        <span>O</span>
                    </div>
                    <button type="button" id="google-login-btn" class="cta-button google-btn">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Logo de Google">
                        <span>Iniciar sesi√≥n con Google</span>
                    </button>
                </form>
            </div>

            <div id="auth-step-register" class="auth-step" style="display: none;">
                <h2>Crear Cuenta</h2>
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-email">Correo Electr√≥nico:</label>
                        <input type="email" id="register-email" name="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Crea una contrase√±a:</label>
                        <input type="password" id="register-password" name="register-password" required>
                    </div>
                    <p id="register-error" class="error-message"></p>
                    <button type="submit" class="cta-button">Crear Cuenta</button>

                    <div class="auth-divider">
                        <span>O</span>
                    </div>
                    <button type="button" id="google-register-btn" class="cta-button google-btn">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Logo de Google">
                        <span>Continuar con Google</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <button id="payment-modal-close-btn" class="modal-close-btn" aria-label="Cerrar pago">&times;</button>
            <h2>üí≥ Realizar Pago</h2>
            <p id="payment-instructions">Por favor, ingrese sus datos para completar la compra.</p>
            <form id="payment-form">
                <div class="form-group">
                    <label for="name">Nombre Completo:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Correo Electr√≥nico:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="card">N√∫mero de Tarjeta:</label>
                    <input type="text" id="card" name="card" placeholder="1234 5678 9012 3456"
                           inputmode="numeric" maxlength="19" pattern="[0-9\\s]*" required>
                    <p id="card-error" class="error-message">Por favor, ingrese un n√∫mero de tarjeta v√°lido de 16 d√≠gitos.</p>
                </div>
                <button type="submit" class="cta-button">Pagar</button>
            </form>
            <div id="success-message" class="success-message">
                ‚úÖ ¬°Pago exitoso! Gracias por tu compra.
            </div>
        </div>
    </div>

    <div id="modal-backdrop" class="modal-backdrop"></div>


    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- C√ìDIGO DEL MEN√ö (Sin cambios) ---
            const menuToggle = document.querySelector('.menu-toggle');
            const nav = document.querySelector('.main-nav');
            menuToggle.addEventListener('click', () => { nav.classList.toggle('is-open'); menuToggle.classList.toggle('is-open'); });
            nav.querySelectorAll('a:not(.submenu-parent > a)').forEach(link => { link.addEventListener('click', () => { nav.classList.remove('is-open'); menuToggle.classList.remove('is-open'); }); });
            const submenuParents = document.querySelectorAll('.submenu-parent > a');
            submenuParents.forEach(parent => { parent.addEventListener('click', (e) => { e.preventDefault(); parent.parentElement.classList.toggle('is-open'); }); });
            document.addEventListener('click', (e) => { const isMenuOpen = nav.classList.contains('is-open'); const clickedInsideNav = nav.contains(e.target); const clickedOnToggle = menuToggle.contains(e.target); if (isMenuOpen && !clickedInsideNav && !clickedOnToggle) { nav.classList.remove('is-open'); menuToggle.classList.remove('is-open'); } });

            
            /* ==============================================
             ETAPA 4.1: CONFIGURACI√ìN DE FIREBASE
            ============================================== */

            const firebaseConfig = {
              apiKey: "AIzaSyDzsClI9HyOdM3Ufjp3xxYfVqus8FhDDto",
              authDomain: "tienda-xoctla-oficial.firebaseapp.com",
              projectId: "tienda-xoctla-oficial",
              storageBucket: "tienda-xoctla-oficial.firebasestorage.app",
              messagingSenderId: "760119415755",
              appId: "1:760119415755:web:4fdc2c8e35a97bb8be1c4e",
              measurementId: "G-DHFKCTNX4E"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const googleProvider = new firebase.auth.GoogleAuthProvider(); // <-- PROVEEDOR DE GOOGLE
            let currentUser = null;
            let isCheckingOut = false;
            
            
            /* ==============================================
             ETAPA 4.2: L√ìGICA DE AUTENTICACI√ìN (MODIFICADA)
            ============================================== */
            
            // --- Elementos del DOM (Autenticaci√≥n) ---
            const authLinks = document.getElementById('auth-links');
            const showLoginBtn = document.getElementById('show-login-btn');
            const showRegisterBtn = document.getElementById('show-register-btn');

            const userStatusDiv = document.getElementById('user-status');
            const userEmailSpan = document.getElementById('user-email');
            const logoutBtn = document.getElementById('logout-btn');
            
            // Modales
            const authModal = document.getElementById('auth-modal');
            const authModalCloseBtn = document.getElementById('auth-modal-close-btn');
            const paymentModal = document.getElementById('payment-modal');
            const paymentModalCloseBtn = document.getElementById('payment-modal-close-btn');
            const backdrop = document.getElementById('modal-backdrop'); // <-- FONDO GRIS

            // Formularios de Autenticaci√≥n
            const authStepLogin = document.getElementById('auth-step-login');
            const loginForm = document.getElementById('login-form');
            const googleLoginBtn = document.getElementById('google-login-btn'); // <-- Bot√≥n Google Login
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginError = document.getElementById('login-error');

            const authStepRegister = document.getElementById('auth-step-register');
            const registerForm = document.getElementById('register-form');
            const googleRegisterBtn = document.getElementById('google-register-btn'); // <-- Bot√≥n Google Register
            const registerEmailInput = document.getElementById('register-email');
            const registerPasswordInput = document.getElementById('register-password');
            const registerError = document.getElementById('register-error');


            // --- Elementos del DOM (Carrito y Pago) ---
            let cart = []; 
            const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
            const cartToggleBtn = document.getElementById('cart-toggle-btn');
            const cartCounter = document.getElementById('cart-counter');
            const cartSidebar = document.getElementById('cart-sidebar');
            const cartCloseBtn = document.getElementById('cart-close-btn');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartTotalElement = document.getElementById('cart-total-price');
            const cartEmptyMsg = document.getElementById('cart-empty-msg');
            const checkoutBtn = document.getElementById('checkout-btn');
            const cartCheckoutError = document.getElementById('cart-checkout-error');

            // Formulario de Pago
            const paymentForm = document.getElementById('payment-form');
            const paymentInstructions = document.getElementById('payment-instructions');
            const paymentEmailInput = document.getElementById('email');
            const successMessage = document.getElementById('success-message');
            const cardError = document.getElementById('card-error');

            // --- Funciones de Modales (Generales) ---
            function openModal(modal) { modal.classList.add('is-open'); backdrop.classList.add('is-open'); }
            function closeModal(modal) { modal.classList.remove('is-open'); backdrop.classList.remove('is-open'); }

            function closeAllModals() {
                closeModal(cartSidebar);
                closeModal(authModal);
                closeModal(paymentModal);
            }
            
            function showAuthStep(stepToShow) {
                if (stepToShow === 'login') {
                    authStepLogin.style.display = 'block';
                    authStepRegister.style.display = 'none';
                } else {
                    authStepLogin.style.display = 'none';
                    authStepRegister.style.display = 'block';
                }
            }

            // --- Eventos de Cierre de Modales ---
            cartCloseBtn.addEventListener('click', () => closeModal(cartSidebar));
            authModalCloseBtn.addEventListener('click', () => closeModal(authModal));
            paymentModalCloseBtn.addEventListener('click', () => closeModal(paymentModal));
            
            // ----- ESTA ES LA L√çNEA QUE HACE LO QUE PIDES -----
            backdrop.addEventListener('click', closeAllModals);
            // ----------------------------------------------------


            // --- Observador de Estado de Autenticaci√≥n (MODIFICADO) ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    userEmailSpan.textContent = `Hola, ${user.email}`;
                    userStatusDiv.style.display = 'block';
                    authLinks.style.display = 'none';
                    paymentEmailInput.value = user.email;

                } else {
                    currentUser = null;
                    userStatusDiv.style.display = 'none';
                    authLinks.style.display = 'block';
                    paymentEmailInput.value = '';
                }
            });

            // --- Listeners para botones del Header ---
            showLoginBtn.addEventListener('click', () => {
                isCheckingOut = false;
                showAuthStep('login');
                openModal(authModal);
            });

            showRegisterBtn.addEventListener('click', () => {
                isCheckingOut = false;
                showAuthStep('register');
                openModal(authModal);
            });


            // --- Flujo de Autenticaci√≥n (MODIFICADO) ---

            // 1. Bot√≥n "Iniciar Sesi√≥n" (Formulario)
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                loginError.textContent = '';

                auth.signInWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        console.log("Usuario inici√≥ sesi√≥n:", userCredential.user.email);
                        loginForm.reset();
                        closeModal(authModal);
                        
                        if (isCheckingOut) {
                            isCheckingOut = false;
                            openModal(paymentModal);
                        }
                    })
                    .catch(error => {
                        loginError.textContent = "Correo o contrase√±a incorrecta.";
                    });
            });

            // 2. Bot√≥n "Crear Cuenta" (Formulario)
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = registerEmailInput.value;
                const password = registerPasswordInput.value;
                registerError.textContent = '';

                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        console.log("Usuario creado:", userCredential.user.email);
                        registerForm.reset();
                        closeModal(authModal);

                        if (isCheckingOut) {
                            isCheckingOut = false;
                            openModal(paymentModal);
                        }
                    })
                    .catch(error => {
                        if (error.code === 'auth/weak-password') {
                            registerError.textContent = 'La contrase√±a debe tener al menos 6 caracteres.';
                        } else {
                            registerError.textContent = 'Error al crear la cuenta.';
                        }
                    });
            });

            // --- L√ìGICA DE GOOGLE ---
            // Esta funci√≥n maneja el clic de AMBOS botones de Google
            function handleGoogleSignIn() {
                loginError.textContent = '';
                registerError.textContent = ''; // Limpia ambos errores

                auth.signInWithPopup(googleProvider)
                    .then(result => {
                        console.log("Usuario inici√≥/registr√≥ con Google:", result.user.email);
                        closeModal(authModal);
                        
                        if (isCheckingOut) {
                            isCheckingOut = false;
                            openModal(paymentModal);
                        }
                    })
                    .catch(error => {
                        console.error("Error en signInWithPopup:", error);
                        const errorMsg = "Error al iniciar con Google. Intenta de nuevo.";
                        if (error.code === 'auth/popup-closed-by-user') {
                            loginError.textContent = "Cancelaste el inicio de sesi√≥n.";
                            registerError.textContent = "Cancelaste el inicio de sesi√≥n.";
                        } else {
                            loginError.textContent = errorMsg;
                            registerError.textContent = errorMsg;
                        }
                    });
            }

            googleLoginBtn.addEventListener('click', handleGoogleSignIn);
            googleRegisterBtn.addEventListener('click', handleGoogleSignIn);


            // 3. Bot√≥n "Cerrar Sesi√≥n"
            logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    console.log("Usuario cerr√≥ sesi√≥n");
                    cart = [];
                    updateCartUI();
                });
            });


            /* ==============================================
             ETAPA 4.3: L√ìGICA DE CARRITO Y PAGO
            ============================================== */

            // --- L√≥gica de Carrito (Sin cambios) ---
            cartToggleBtn.addEventListener('click', () => openModal(cartSidebar));
            
            addToCartButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const productCard = button.closest('.producto');
                    const product = {
                        id: productCard.dataset.id,
                        nombre: productCard.dataset.nombre,
                        precio: parseFloat(productCard.dataset.precio),
                        cartId: Date.now() + Math.random() 
                    };
                    cart.push(product);
                    updateCartUI();
                    openModal(cartSidebar);
                });
            });
            
            function updateCartUI() {
                cartCheckoutError.style.display = 'none'; 
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    cartItemsContainer.appendChild(cartEmptyMsg.cloneNode(true));
                    cartTotalElement.textContent = '0.00';
                    cartCounter.textContent = '0';
                    cartCounter.style.display = 'none';
                } else {
                    let total = 0;
                    cart.forEach(item => {
                        const cartItem = document.createElement('div');
                        cartItem.className = 'cart-item';
                        cartItem.innerHTML = `
                            <span>${item.nombre} ($${item.precio.toFixed(2)})</span>
                            <button class="cart-item-remove-btn" data-cart-id="${item.cartId}">&times;</button>
                        `;
                        cartItemsContainer.appendChild(cartItem);
                        total += item.precio;
                    });
                    cartTotalElement.textContent = total.toFixed(2);
                    cartCounter.textContent = cart.length;
                    cartCounter.style.display = 'block';
                }
            }
            
            cartItemsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('cart-item-remove-btn')) {
                    const idToRemove = parseFloat(e.target.dataset.cartId);
                    cart = cart.filter(item => item.cartId !== idToRemove);
                    updateCartUI();
                }
            });
            
            // --- L√ìGICA DE CHECKOUT (¬°MODIFICADA!) ---
            checkoutBtn.addEventListener('click', () => {
                cartCheckoutError.style.display = 'none';
                if (cart.length === 0) {
                    cartCheckoutError.style.display = 'block';
                    return;
                }

                closeModal(cartSidebar);
                
                if (auth.currentUser) {
                    openModal(paymentModal);
                } else {
                    isCheckingOut = true;
                    showAuthStep('login');
                    openModal(authModal);
                }
            });


            // --- L√≥gica de Pago (MODIFICADA) ---
            paymentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (cart.length === 0) return;

                const cardInput = document.getElementById('card');
                const cardNumber = cardInput.value.replace(/\s/g, '');
                cardError.style.display = 'none';

                if (cardNumber.length !== 16 || isNaN(cardNumber)) {
                    cardError.style.display = 'block';
                    return;
                }
                
                paymentInstructions.style.display = 'none';
                paymentForm.style.display = 'none';
                successMessage.style.display = 'block';

                setTimeout(() => {
                    successMessage.style.display = 'none';
                    paymentInstructions.style.display = 'block';
                    paymentForm.style.display = 'block';
                    paymentForm.reset();
                    cart = [];
                    updateCartUI();
                    
                    closeModal(paymentModal); 
                    
                    window.scrollTo(0, 0);
                }, 3000);
            });

            // Iniciar UI
            updateCartUI();
        });
    </script>

</body>
</html>